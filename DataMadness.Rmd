---
title: "Data Madness"
author: "Martin Gassner, Henry Mauranen"
date: "17 March 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
  knitr::opts_chunk$set(
  fig.path = "images/"
)
```


```{r libraries, message=FALSE, warning=FALSE, error=FALSE}
library(dplyr)
library(ggplot2)
library(car)
library(klaR)
library(mclust)
library(stringr)
library( mice )
library( reshape2 )
library(grDevices)
```

## Introduction



```{r data_import}
load("./measuringMoralityDuke/MMdata_merged.rdata")
personalColumns <- colnames(MMdata_merged)[255:278]

MMdata_merged[is.na(MMdata_merged)] <- -1

# Leaving out single valued questions, because they can be grouped when constructing the blocks later on
questionIds <- c("C","I","RFQ","REI","MR","EPQ","L","DPES","SP","DIT","RAND_DIT","MELS","MOPS","Dov_mops","MFSS","MI","CQR","IS","SV","TET","EVA")

patternIds <- function( names, pat ) names[ !is.na( str_extract( names, pat ) ) ]

regexes <- sapply(questionIds, function(x){
  paste0("^",x,"[0-9]+(_[A-Z])?$")
  })

questionIdNames <- sapply(regexes, function(x) {
  patternIds(colnames(MMdata_merged), x)
})

block1 <- questionIdNames$C
block2 <- c(questionIdNames$I, questionIdNames$RFQ)
block3 <- questionIdNames$REI
block4 <- c(questionIdNames$MR, questionIdNames$EPQ)
block5 <- questionIdNames$L
block6 <- questionIdNames$DPES
block7 <- c(questionIdNames$DIT, questionIdNames$RAND_DIT)
block8 <- c(questionIdNames$MELS, questionIdNames$MOPS)
block9 <- questionIdNames$MFSS
block10 <- questionIdNames$MI
block11 <- questionIdNames$CQR
block12 <- questionIdNames$IS
block13 <- questionIdNames$SV
block14 <- questionIdNames$TET
block15 <- "Block15"
block16 <- questionIdNames$EVA
block17 <- "Dov_game"

blocks <- list(block1,block2,block3,block4,block5,block6,block7,block8,block9,block10,block11,block12,block13,block14,block15,block16,block17)
```

```{r clustering, warning=FALSE}
# Suppressing warnings because Loess causes problems with spms

# This block is commented out, because it should not be run as one. Commands are heavy and produce a lot of output. Choose which plots and cluster you want to examine before running commands.

#mclusters <- lapply(blocks, function (x) {
#  Mclust(MMdata_merged[x])
#})

# Printing all summaires for all clusters
#lapply(mclusters, summary, parameters=TRUE)

# Ignoring 15 and 17, since there's only one question
#clusterBlocks <- blocks[-c(15,17)]
# spm generation for inside the blocks
#lapply(clusterBlocks, function(x){
#  columns <- paste0("~", paste(x, collapse = "+"))
#  spm(as.formula(columns), MMdata_merged)
#})
```

```{r principal_component_analysis}
# for pca
MMdata_merged.zerofill <- MMdata_merged
MMdata_merged.zerofill[ is.na( MMdata_merged ) ] <- 0
MMdata_merged.zerofill[ MMdata_merged.zerofill == -1 ] <- 0
blocks.pcs <- lapply( blocks, function( b ) princomp( MMdata_merged.zerofill[ b ] ) )
#nonsense
#blocks.lds <- sapply( blocks.pcs, loadings ) 

blocks.weights.raw <- sapply( blocks.pcs, function( pc ) 
  {
    parvs <- pc$sdev / sum( pc$sdev )
    cumvs <- cumsum( parvs )
    sigCs <- cumvs < 0.85
    if( length( sigCs ) > 1)
      return( apply( abs( parvs[ sigCs ] * pc$loadings[ ,sigCs ] ), 1, sum) )
    else
      return( sum( pc$loadings) )
  }
)

blocks.weights.norm <- sapply( blocks.weights.raw, function( ws ) ws / sum( ws ) )
blocks.weights.norm.df <- as.data.frame( melt( blocks.weights.norm ) )
blocks.weights.norm.df$name <- unlist( blocks )
ggplot( blocks.weights.norm.df[ blocks.weights.norm.df$L1 != c(15, 17), ]
        , aes( x=name, y=value ) ) + 
  geom_col() + 
  facet_wrap( ~L1, ncol=4, scales="free" ) +
  theme( axis.text.x=element_text( angle=45, hjust=1 ))
```
