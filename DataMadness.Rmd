---
title: "Data Madness"
author: "Martin Gassner, Henry Mauranen"
date: "17 March 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r libraries, message=FALSE, warning=FALSE, error=FALSE}
library(dplyr)
library(ggplot2)
library(car)
library(klaR) # Probably won't use this
library(mclust)
library(stringr)
library(cluster)
```

## Introduction



```{r data_import}
load("./measuringMoralityDuke/MMdata_merged.rdata")
personalColumns <- colnames(MMdata_merged)[255:278]


# Leaving out single valued questions, because they can be grouped when constructing the blocks later on
questionIds <- c("C","I","RFQ","REI","MR","EPQ","L","DPES","SP","DIT","RAND_DIT","MELS","MOPS","Dov_mops","MFSS","MI","CQR","IS","SV","TET","EVA")

patternIds <- function( names, pat ) names[ !is.na( str_extract( names, pat ) ) ]

regexes <- sapply(questionIds, function(x){
  paste0("^",x,"[0-9]+(_[A-Z])?$")
  })

questionIdNames <- sapply(regexes, function(x) {
  patternIds(colnames(MMdata_merged), x)
})

block1 <- questionIdNames$C
block2 <- c(questionIdNames$I, questionIdNames$RFQ)
block3 <- questionIdNames$REI
block4 <- c(questionIdNames$MR, questionIdNames$EPQ)
block5 <- questionIdNames$L
block6 <- questionIdNames$DPES
block7 <- c(questionIdNames$DIT, questionIdNames$RAND_DIT)
block8 <- c(questionIdNames$MELS, questionIdNames$MOPS)
block9 <- questionIdNames$MFSS
block10 <- questionIdNames$MI
block11 <- questionIdNames$CQR
block12 <- questionIdNames$IS
block13 <- questionIdNames$SV
block14 <- questionIdNames$TET
block15 <- "Block15"
block16 <- questionIdNames$EVA
block17 <- "Dov_game"

blocks <- list(block1,block2,block3,block4,block5,block6,block7,block8,block9,block10,block11,block12,block13,block14,block15,block16,block17)
```

```{r clustering}
mclusters <- sapply(blocks, function (x) {
  
})

```

```{r principle_component_analysis}
# for pca
pcs <- princomp( data )
loadings( pca )
```

```{r kmodes_methods}
# Define methods for the clusters

get_tot_diffs <- function(x) {
  # Get the maximum difference for 15 different cluster sizes (from 2 to 16)
  kmode_res <- lapply(1:15, function(i){kmodes(x, i+1)})
  diffs <- lapply(kmode_res, function(y){sum(y$withindiff)})
  return(unlist(diffs))
}

test_kmodes_runs <- function(x, tests=5) {
  # Runs the get_max_diffs function different times to average out the random initial seed of kmodes
  all_tests <- lapply(1:tests, function(y) {get_tot_diffs(x)})
  
  # Returns dataframe with runs as rows and cluster number as columns (V[number of clusters - 1])
  return(as.data.frame(do.call(rbind, all_tests)))
}

avg_diffs_for_block <- function(x, tests = 20) {
  # Averages the cluster scores given by the previous method
  run_for_block <- test_kmodes_runs(x, tests = tests)
  print('Finished testing for one block')
  return(sapply(names(run_for_block), function(y) {mean(run_for_block[,y])}))
}
```

```{r kmodes_on_blocks}

block_1_kmodes <- avg_diffs_for_block(MMdata_merged[,block1])

all_avgs <- lapply(blocks, function(x){avg_diffs_for_block(MMdata_merged[,x])})

```


```{r data_import}

```

```{r data_import}

```

```{r data_import}

```

```{r data_import}

```